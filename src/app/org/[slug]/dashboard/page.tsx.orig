import { auth } from '@/auth';
import { redirect } from 'next/navigation';
import { ROLES } from '@/lib/constants';
import prisma from '@/lib/prisma';
import OrgStudentDashboard from '@/components/org/OrgStudentDashboard';
import TeacherDashboard from '@/components/org/TeacherDashboard';
import OrgOwnerDashboard from '@/components/org/OrgOwnerDashboard';

async function getOrgData(user: any) {
    const role = user.role;
    const orgId = user.organizationId;
    const userId = user.id;

    try {
        if (role === ROLES.TEACHER) {
            const [myTests, myQuestions, totalSubmissions, recentAttempts] = await Promise.all([
                prisma.test.findMany({
                    where: { createdById: userId },
                    include: { _count: { select: { testAttempts: true } } },
                    orderBy: { createdAt: 'desc' },
                    take: 20,
                }),
                prisma.question.count({ where: { createdById: userId } }),
                prisma.userTestAttempt.count({ where: { test: { createdById: userId } } }),
                prisma.userTestAttempt.findMany({
                    where: { test: { createdById: userId } },
                    include: {
                        user: { select: { name: true, email: true } },
                        test: { select: { title: true } },
                    },
                    orderBy: { startedAt: 'desc' },
                    take: 15,
                }),
            ]);

            return {
                role,
                stats: {
                    myTests: myTests.length,
                    myQuestions,
                    totalSubmissions,
                    activeTests: myTests.filter((t: any) => t.status === 'LIVE').length,
                },
                myTests,
                recentAttempts,
            };
        }

        if (role === ROLES.ORG_OWNER) {
            const [members, tests, questions, attempts, teachers, students] = await Promise.all([
                prisma.user.count({ where: { organizationId: orgId } }),
                prisma.test.findMany({
                    where: { organizationId: orgId },
                    include: {
                        createdBy: { select: { name: true } },
                        _count: { select: { testAttempts: true } },
                    },
                    orderBy: { createdAt: 'desc' },
                }),
                prisma.question.count({ where: { organizationId: orgId } }),
                prisma.userTestAttempt.findMany({
                    where: { organizationId: orgId },
                    include: {
                        user: { select: { name: true, email: true, role: true } },
                        test: { select: { title: true, createdBy: { select: { name: true } } } },
                    },
                    orderBy: { startedAt: 'desc' },
                    take: 25,
                }),
                prisma.user.findMany({
                    where: { organizationId: orgId, role: ROLES.TEACHER },
                    select: {
                        id: true, name: true, email: true, createdAt: true,
                        _count: { select: { createdTests: true } },
                    },
                }),
                prisma.user.findMany({
                    where: { organizationId: orgId, role: 'USER' },
                    select: {
                        id: true, name: true, email: true, createdAt: true,
                        _count: { select: { testAttempts: true } },
                    },
                }),
            ]);

            const avgScore = attempts.length > 0
                ? (attempts.reduce((s: number, a: any) => s + a.score, 0) / attempts.length).toFixed(1)
                : 0;

            return {
                role,
                stats: {
                    totalMembers: members,
                    totalTests: tests.length,
                    totalQuestions: questions,
                    totalAttempts: attempts.length,
                    activeTests: tests.filter((t: any) => t.status === 'LIVE').length,
                    avgScore,
                    teacherCount: teachers.length,
                    studentCount: students.length,
                },
                tests,
                attempts,
                teachers,
                students,
            };
        }

        // Org Student
        if (orgId) {
            const [assignedTests, orgTests, myAttempts] = await Promise.all([
                prisma.testAssignment.findMany({
                    where: { studentId: userId },
                    include: { test: { include: { createdBy: { select: { name: true } } } } },
                }),
                prisma.test.findMany({
                    where: { organizationId: orgId, status: 'LIVE' },
                    include: { createdBy: { select: { name: true } } },
                }),
                prisma.userTestAttempt.findMany({
                    where: { userId },
                    include: { test: { select: { title: true, totalMarks: true } } },
                    orderBy: { startedAt: 'desc' },
                }),
            ]);

            const avgAccuracy = myAttempts.length > 0
                ? (myAttempts.reduce((s: number, a: any) => s + a.accuracy, 0) / myAttempts.length).toFixed(1)
                : 0;

            return {
                role: 'ORG_STUDENT',
                stats: {
                    assignedCount: assignedTests.length,
                    orgTestCount: orgTests.length,
                    attemptedCount: myAttempts.length,
                    avgAccuracy,
                },
                assignedTests,
                orgTests,
                myAttempts,
            };
        }
    } catch (e: any) {
        console.error('getOrgData error:', e.message);
        return null;
    }
}

export default async function OrgDashboardPage() {
    const session = await auth();
    if (!session?.user) redirect('/login');

    const user = session.user as any;

    // Normal users without an org â†’ go to regular dashboard
    if (!user.organizationId && user.role === ROLES.USER) {
        redirect('/dashboard');
    }

    const orgData = await getOrgData(user);

    if (!orgData) {
        return (
            <div className="flex items-center justify-center h-96">
                <div className="text-center">
                    <p className="font-bold text-lg mb-2">Failed to load organization data.</p>
                    <p className="text-muted text-sm">Please try refreshing the page.</p>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-background">
            <div className="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                {user.role === ROLES.ORG_OWNER && <OrgOwnerDashboard orgData={orgData} />}
                {user.role === ROLES.TEACHER && <TeacherDashboard orgData={orgData} />}
                {(user.role === ROLES.USER && user.organizationId) && <OrgStudentDashboard orgData={orgData} />}
            </div>
        </div>
    );
}
