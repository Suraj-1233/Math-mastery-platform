datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

model User {
  id                 String    @id @default(cuid())
  name               String?
  email              String    @unique
  password           String?   // Hashed
  role               String    @default("USER")
  subscriptionStatus String    @default("FREE")
  createdAt          DateTime  @default(now())
  
  progress           UserProgress[]
  testAttempts       UserTestAttempt[]
}

model Question {
  id                String     @id @default(cuid())
  text              String     // Markdown/LaTeX supported
  textHi            String?    // Hindi translated text
  options           String     // JSON: Array of { text: string, imageUrl?: string }
  correctOptionIndex Int
  explanation       String?    // Detailed solution
  explanationHi     String?    // Hindi translated explanation
  subject           String
  topic             String?
  difficulty        String     @default("MEDIUM")
  examType          String     // e.g., "SSC_CGL", "RAILWAY"
  year              Int?
  imageUrl          String?    // Primary feature image
  imageWidth        Int?       // Width in pixels
  imageHeight       Int?       // Height in pixels
  tags              String?    // comma-separated
  isPremium         Boolean    @default(false)
  questionType      String     @default("MCQ") // MCQ, NUMERIC, TRUE_FALSE
  metadata          String?    // Flat JSON for extra props (source, specific exam shift, etc.)
  solveAttemptCount Int        @default(0)
  wrongAttemptCount Int        @default(0)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  occurrences       QuestionOccurrence[]
  media             Media[]
  userProgress      UserProgress[]

  @@index([difficulty])
  @@index([solveAttemptCount])
}

model QuestionOccurrence {
  id         String   @id @default(cuid())
  examName   String   // e.g., "SSC CGL"
  year       Int      // e.g., 2023
  shift      String?  // e.g., "Morning", "Shift 2"
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
}


model Media {
  id         String   @id @default(cuid())
  url        String
  type       String   @default("IMAGE") // IMAGE, VIDEO, PDF
  width      Int?     // Width in pixels
  height     Int?     // Height in pixels
  caption    String?
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
}


model UserProgress {
  id          String   @id @default(cuid())
  userId      String
  questionId  String
  status      String   // "CORRECT", "WRONG", "BOOKMARKED"
  
  isSolved    Boolean  @default(false)
  isCorrect   Boolean  @default(false)
  isBookmarked Boolean @default(false)
  
  attemptedAt DateTime @default(now())
  timeTaken   Int?     // Seconds
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId, isBookmarked])
  @@index([userId, isSolved])
}


model UserTestAttempt {
  id          String   @id @default(cuid())
  userId      String
  testId      String
  score       Float
  accuracy    Float
  rank        Int?
  answersJson String     // Store JSON stringified map of { questionId: selectedIndex }
  startedAt   DateTime @default(now())
  completedAt DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
